apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: alloy-metrics
data:
  config.alloy: |
    prometheus.remote_write "mimir" {
      endpoint {
        url = "http://mimir-gateway.mimir.svc.cluster.local/api/v1/push"
        headers = {
          "X-Scope-OrgID" = "pods",
        }
      }
    }

    discovery.kubernetes "nodes" {
      role = "node"
    }

    discovery.relabel "kubelet" {
      targets = discovery.kubernetes.nodes.targets
      rule {
        target_label = "__address__"
        replacement  = "kubernetes.default.svc:443"
      }
      rule {
        source_labels = ["__meta_kubernetes_node_name"]
        target_label  = "__metrics_path__"
        replacement   = "/api/v1/nodes/$1/proxy/metrics"
      }
      rule {
        action = "labelmap"
        regex  = "__meta_kubernetes_node_label_(.+)"
      }
    }

    discovery.relabel "kubelet_cadvisor" {
      targets = discovery.kubernetes.nodes.targets
      rule {
        target_label = "__address__"
        replacement  = "kubernetes.default.svc:443"
      }
      rule {
        source_labels = ["__meta_kubernetes_node_name"]
        target_label  = "__metrics_path__"
        replacement   = "/api/v1/nodes/$1/proxy/metrics/cadvisor"
      }
      rule {
        action = "labelmap"
        regex  = "__meta_kubernetes_node_label_(.+)"
      }
    }
      rule {
        target_label = "metrics_path"
        replacement  = "/metrics/cadvisor"
      }
    }
    discovery.kubernetes "ksm" {
      role = "service"
      selectors {
        role  = "service"
        label = "app.kubernetes.io/name=kube-state-metrics"
      }
    }

    prometheus.scrape "kubelet" {
      targets         = discovery.relabel.kubelet.output
      scrape_interval = "30s"
      scheme          = "https"
      bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tls_config {
        ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
      }
      forward_to = [prometheus.remote_write.mimir.receiver]
    }

    prometheus.scrape "kubelet_cadvisor" {
      targets         = discovery.relabel.kubelet_cadvisor.output
      scrape_interval = "30s"
      scheme          = "https"
      job_name        = "kubelet" 
      bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tls_config {
        ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
      }
      forward_to = [prometheus.remote_write.mimir.receiver]
    }

    prometheus.scrape "ksm" {
      targets         = discovery.kubernetes.ksm.targets
      scrape_interval = "30s"
      job_name        = "kube-state-metrics"
      forward_to      = [prometheus.remote_write.mimir.receiver]
    }

    prometheus.operator.podmonitors "primary" {
      forward_to = [prometheus.remote_write.mimir.receiver]
      selector { match_labels = { instance = "primary" } }
    }

    prometheus.operator.servicemonitors "primary" {
      forward_to = [prometheus.remote_write.mimir.receiver]
      selector { match_labels = { instance = "primary" } }
    }

    mimir.rules.kubernetes "pods" {
      address   = "http://mimir-ruler.mimir.svc.cluster.local:8080"
      tenant_id = "pods"
      rule_namespace_selector {
        match_labels = { alloy_rules = "pods" }
      }
      rule_selector {
        match_labels = { alloy_rules = "pods" }
      }
    }