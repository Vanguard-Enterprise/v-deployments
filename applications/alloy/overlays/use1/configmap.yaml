apiVersion: v1
kind: ConfigMap
metadata:
  name: alloy-config
  namespace: alloy-metrics
data:
  config.alloy: |
    prometheus.remote_write "mimir" {
      endpoint {
        url = "http://mimir-gateway.mimir.svc.cluster.local/api/v1/push"
        headers = {
          "X-Scope-OrgID" = "pods",
        }
      }
    }

    // Relabel to drop high-cardinality labels and unused metrics
    prometheus.relabel "drop_high_cardinality" {
      forward_to = [prometheus.remote_write.mimir.receiver]

      // Drop container id/name labels that explode cardinality
      rule {
        action = "labeldrop"
        regex  = "id|name|container_id|image_id|image"
      }

      // Drop metrics that are rarely used
      rule {
        source_labels = ["__name__"]
        regex         = "container_tasks_state|container_memory_failures_total|container_blkio_device_usage_total|container_fs_inodes_free|container_fs_inodes_total|container_fs_io_current|container_fs_io_time_seconds_total|container_fs_io_time_weighted_seconds_total|container_fs_limit_bytes|container_fs_read_seconds_total|container_fs_reads_merged_total|container_fs_sector_reads_total|container_fs_sector_writes_total|container_fs_write_seconds_total|container_fs_writes_merged_total|container_last_seen|container_scrape_error|container_sockets|container_spec_cpu_period|container_spec_cpu_quota|container_spec_cpu_shares|container_start_time_seconds|container_threads|container_threads_max|container_ulimits_soft"
        action        = "drop"
      }
    }

    discovery.kubernetes "nodes" {
      role = "node"
    }

    discovery.relabel "kubelet" {
      targets = discovery.kubernetes.nodes.targets
      rule {
        target_label = "__address__"
        replacement  = "kubernetes.default.svc:443"
      }
      rule {
        source_labels = ["__meta_kubernetes_node_name"]
        target_label  = "__metrics_path__"
        replacement   = "/api/v1/nodes/$1/proxy/metrics"
      }
      rule {
        action = "labelmap"
        regex  = "__meta_kubernetes_node_label_(.+)"
      }
    }

    discovery.relabel "kubelet_cadvisor" {
      targets = discovery.kubernetes.nodes.targets
      rule {
        target_label = "__address__"
        replacement  = "kubernetes.default.svc:443"
      }
      rule {
        source_labels = ["__meta_kubernetes_node_name"]
        target_label  = "__metrics_path__"
        replacement   = "/api/v1/nodes/$1/proxy/metrics/cadvisor"
      }
      rule {
        action = "labelmap"
        regex  = "__meta_kubernetes_node_label_(.+)"
      }
      rule {
        target_label = "metrics_path"
        replacement  = "/metrics/cadvisor"
      }
    }

    discovery.kubernetes "ksm" {
      role = "service"
      selectors {
        role  = "service"
        label = "app.kubernetes.io/name=kube-state-metrics"
      }
    }

    prometheus.scrape "kubelet" {
      targets         = discovery.relabel.kubelet.output
      scrape_interval = "30s"
      scheme          = "https"
      bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tls_config {
        ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
      }
      forward_to = [prometheus.remote_write.mimir.receiver]
    }

    prometheus.scrape "kubelet_cadvisor" {
      targets         = discovery.relabel.kubelet_cadvisor.output
      scrape_interval = "30s"
      scheme          = "https"
      job_name        = "kubelet"
      bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
      tls_config {
        ca_file = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
      }
      forward_to = [prometheus.relabel.drop_high_cardinality.receiver]
    }

    prometheus.scrape "ksm" {
      targets         = discovery.kubernetes.ksm.targets
      scrape_interval = "30s"
      job_name        = "kube-state-metrics"
      forward_to      = [prometheus.remote_write.mimir.receiver]
    }

    prometheus.operator.podmonitors "primary" {
      forward_to = [prometheus.remote_write.mimir.receiver]
      selector { match_labels = { instance = "primary" } }
    }

    prometheus.operator.servicemonitors "primary" {
      forward_to = [prometheus.remote_write.mimir.receiver]
      selector { match_labels = { instance = "primary" } }
    }

    mimir.rules.kubernetes "pods" {
      address   = "http://mimir-ruler.mimir.svc.cluster.local:8080"
      tenant_id = "pods"
      rule_namespace_selector {
        match_labels = { alloy_rules = "pods" }
      }
      rule_selector {
        match_labels = { alloy_rules = "pods" }
      }
    }
