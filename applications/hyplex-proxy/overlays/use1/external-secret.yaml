apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: hyplex-proxy-config
  namespace: hyplex-proxy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: hyplex-proxy-config
    creationPolicy: Owner
    template:
      data:
        config.toml: |
          schema_version = 1

          [listener]
          host = "0.0.0.0"
          port = 25565

          [security]
          proxy_secret = "{{ .PROXY_SECRET }}"
          token_ttl_millis = 30000

          [[backends]]
          id = "lobby"
          host = "10.1.50.42"
          port = 7860

          [routing]
          default_backend_id = "lobby"

          [messaging]
          host = "0.0.0.0"
          port = 25570
          enabled = true
          control_sender_id = "proxy"
          control_max_payload = 8192
          control_replay_window_ms = 10000

          [rate_limits]
          connection_per_ip = 10
          connection_window_seconds = 60
          handshake_per_ip = 5
          handshake_window_seconds = 60
          streams_per_session = 100
          streams_window_seconds = 60
          invalid_packets_per_session = 10
          invalid_packets_window_seconds = 60

          [referral]
          host = "10.1.50.190"
          port = 25565

  data:
    - secretKey: PROXY_SECRET
      remoteRef:
        key: "hyplex/production/proxy"
        property: PROXY_SECRET