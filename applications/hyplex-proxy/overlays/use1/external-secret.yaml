apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: hyplex-proxy-config
  namespace: hyplex-proxy
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: hyplex-proxy-config
    creationPolicy: Owner
    template:
      data:
        config.toml: |
          schema_version = 1

          [listener]
          host = "0.0.0.0"
          port = 25565

          [security]
          proxy_secret = "{{ .PROXY_SECRET }}"
          token_ttl_millis = 30000

          [[backends]]
          id = "lobby"
          host = "lobby-service.hyplex.svc.cluster.local"
          port = 25566

          [routing]
          default_backend_id = "lobby"

          [messaging]
          host = "0.0.0.0"
          port = 25568
          enabled = true
  data:
    - secretKey: PROXY_SECRET
      remoteRef:
        key: "hyplex-proxy/production"
        property: PROXY_SECRET
