apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: netbird-server-config
  namespace: netbird
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  data:
    - secretKey: auth_secret
      remoteRef:
        key: netbird/environment
        property: NB_AUTH_SECRET
    - secretKey: management_json
      remoteRef:
        key: netbird/management
        property: management.json
  target:
    name: netbird-server-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: Opaque
      data:
        config.yaml: |
          server:
            listenAddress: ":80"
            exposedAddress: "https://netbird.vngenterprise.com:443"
            stunPorts:
              - 3478
            metricsPort: 9090
            healthcheckAddress: ":9000"
            logLevel: "info"
            logFile: "console"
            authSecret: "{{ .auth_secret }}"
            dataDir: "/var/lib/netbird/"
            disableAnonymousMetrics: false
            auth:
              issuer: "https://netbird.vngenterprise.com/oauth2"
              signKeyRefreshEnabled: true
              dashboardRedirectURIs:
                - "https://netbird.vngenterprise.com/nb-auth"
                - "https://netbird.vngenterprise.com/nb-silent-auth"
              cliRedirectURIs:
                - "http://localhost:53000/"
            store:
              engine: "sqlite"
              encryptionKey: "{{ (fromJson .management_json).DataStoreEncryptionKey }}"
